package com.motivewave.platform.study.strategies;import java.awt.Color;import com.motivewave.platform.sdk.common.Coordinate;import com.motivewave.platform.sdk.common.DataContext;import com.motivewave.platform.sdk.common.Defaults;import com.motivewave.platform.sdk.common.Enums;import com.motivewave.platform.sdk.common.Util;import com.motivewave.platform.sdk.common.desc.BooleanDescriptor;import com.motivewave.platform.sdk.common.desc.ColorDescriptor;import com.motivewave.platform.sdk.common.desc.GuideDescriptor;import com.motivewave.platform.sdk.common.desc.IndicatorDescriptor;import com.motivewave.platform.sdk.common.desc.InputDescriptor;import com.motivewave.platform.sdk.common.desc.IntegerDescriptor;import com.motivewave.platform.sdk.common.desc.MAMethodDescriptor;import com.motivewave.platform.sdk.common.desc.MarkerDescriptor;import com.motivewave.platform.sdk.common.desc.PathDescriptor;import com.motivewave.platform.sdk.common.desc.ShadeDescriptor;import com.motivewave.platform.sdk.common.desc.ValueDescriptor;import com.motivewave.platform.sdk.draw.Marker;import com.motivewave.platform.sdk.order_mgmt.OrderContext;import com.motivewave.platform.sdk.study.Plot;import com.motivewave.platform.sdk.study.Study;import com.motivewave.platform.sdk.study.StudyHeader;import com.motivewave.platform.study.general.Utility;import com.motivewave.platform.study.general3.Str;import com.motivewave.platform.study.strategies.Account.Signal;@StudyHeader(  namespace="com.motivewave",  rb="com.motivewave.platform.study.nls.strings2",  id="ID_PRICE_ZONE_STRATEGY",  name="NAME_PRICE_ZONE_STRATEGY",  desc="DESC_PRICE_ZONE_STRATEGY",  label="LBL_PZS",  menu="MENU_GENERAL",  helpLink="http://www.motivewave.com/strategies/price_zone_strategy.htm",  overlay=false,  signals=true,  strategy=true,  autoEntry=true,  manualEntry=false,  supportsEnterOnActivate=false,  supportsUnrealizedPL=true,  supportsRealizedPL=true,  supportsTotalPL=true,  supportsPositionType=false,  supportsBarUpdates=false)public class PriceZoneStrategy extends Study{  static final String REDUCE_WS="ReduceWS";    enum Values { R, PZO, MA, PDM, NDM, TR, DX, PDI, NDI, ADX }  Marker activeMarker=null;  long activationTime=0;  double price=0;  Account acc=new Account(Account.PosType.SAR, Account.OrdType.MARKET, Account.CLOSED);  @Override  public void initialize(Defaults defaults)  {    Account.studyThis=this; // give Accounts access to get(str);    var sd=createSD();    var tab=sd.addTab(get("DISPLAY1"));    var inputs=tab.addGroup(get("INPUTS"));    inputs.addRow(new InputDescriptor(Str.INPUT1, get("INPUT"), Enums.BarInput.CLOSE));    inputs.addRow(new MAMethodDescriptor(Str.METHOD1, get("METHOD"), Enums.MAMethod.EMA));    inputs.addRow(new IntegerDescriptor(Str.PERIOD1, get("PERIOD"), 14, 1, 999, 1));    inputs.addRow(new IntegerDescriptor(Str.PERIOD2, get("MA_PERIOD"), 60, 1, 999, 1));    inputs.addRow(new BooleanDescriptor(REDUCE_WS, get("REDUCE_WHIPSAWS"), true));    var settings=tab.addGroup(get("PATHS"));    settings.addRow(new PathDescriptor(Str.PATH1, get("PZO"), defaults.getLineColor(), 1.0f, null, true, false, true));    settings.addRow(new PathDescriptor(Str.PATH2, get("MA"), defaults.getRed(), 1.0f, null, true, false, true));    settings.addRow(new PathDescriptor(Str.PATH3, get("ADX_PATH"), defaults.getBlue(), 1.0f, null, true, false, true));    settings.addRow(new ColorDescriptor(Str.UP_COLOR, get("ADX_UP_COLOR"), defaults.getBlue()));    settings.addRow(new ColorDescriptor(Str.DN_COLOR, get("ADX_DOWN_COLOR"), defaults.getRed()));    tab=sd.addTab(get("DISPLAY2"));    settings=tab.addGroup(get("INDICATORS"));    settings.addRow(new IndicatorDescriptor(Str.IND1, get("PZO"), defaults.getLineColor(), null, false, true, true));    settings.addRow(new IndicatorDescriptor(Str.IND2, get("MA"), defaults.getRed(), null, false, true, true));    settings.addRow(new IndicatorDescriptor(Str.IND3, get("ADX"), defaults.getBlue(), null, false, true, true));    var guides=tab.addGroup(get("VZO_GUIDES"));    var topDesc1=new GuideDescriptor(Str.TOP_GUIDE1, get("TOP_GUIDE1"), 60, 0, 99, 1, true);    topDesc1.setLineColor(defaults.getRed());    guides.addRow(topDesc1);    var topDesc2=new GuideDescriptor(Str.TOP_GUIDE2, get("TOP_GUIDE2"), 40, 0, 99, 1, true);    topDesc2.setLineColor(defaults.getRed());    guides.addRow(topDesc2);    var topDesc3=new GuideDescriptor(Str.TOP_GUIDE3, get("TOP_GUIDE3"), 15, 0, 99, 1, true);    topDesc3.setLineColor(defaults.getRed());    guides.addRow(topDesc3);    var mg=new GuideDescriptor(Str.MID_GUIDE1, get("MIDDLE_GUIDE"), 0, -99, 99, 1, true);    mg.setDash(new float[] { 3, 3 });    guides.addRow(mg);    var bottomDesc1=new GuideDescriptor(Str.BOTT_GUIDE1, get("BOTTOM_GUIDE1"), -5, 0, -99, 1, true);    bottomDesc1.setLineColor(defaults.getGreen());    guides.addRow(bottomDesc1);    var bottomDesc2=new GuideDescriptor(Str.BOTT_GUIDE2, get("BOTTOM_GUIDE2"), -40, 0, -99, 1, true);    bottomDesc2.setLineColor(defaults.getGreen());    guides.addRow(bottomDesc2);    var bottomDesc3=new GuideDescriptor(Str.BOTT_GUIDE3, get("BOTTOM_GUIDE3"), -60, 0, -99, 1, true);    bottomDesc3.setLineColor(defaults.getGreen());    guides.addRow(bottomDesc3);    tab=sd.addTab(get("DISPLAY3"));    var guides2=tab.addGroup(get("ADX_GUIDES"));    var topDesc4=new GuideDescriptor(Str.TOP_GUIDE4, get("TOP_GUIDE"), 26, 0, 99, 1, true);    topDesc4.setLineColor(defaults.getRed());    guides2.addRow(topDesc4);    var mg4=new GuideDescriptor(Str.MID_GUIDE4, get("MIDDLE_GUIDE"), 18, 0, 99, 1, true);    mg4.setDash(new float[] { 3, 3 });    guides2.addRow(mg4);    var bottomDesc4=new GuideDescriptor(Str.BOTT_GUIDE4, get("BOTTOM_GUIDE"), 0, 0, 99, 1, true);    bottomDesc4.setLineColor(defaults.getGreen());    guides2.addRow(bottomDesc4);    settings=tab.addGroup(get("SHADING"));    settings.addRow(new ShadeDescriptor(Str.TOP_FILL1, get("TOP_FILL"), Str.MID_GUIDE1, Str.PATH1,        Enums.ShadeType.ABOVE, defaults.getTopFillColor(), true, true));    settings.addRow(new ShadeDescriptor(Str.BOTT_FILL1, get("BOTTOM_FILL"), Str.MID_GUIDE1, Str.PATH1,        Enums.ShadeType.BELOW, defaults.getBottomFillColor(), true, true));    var markers=tab.addGroup(get("MARKERS"));    markers.addRow(new MarkerDescriptor(Str.UP_MARKER1, get("ENTER_LONG"), Enums.MarkerType.TRIANGLE,        Enums.Size.VERY_SMALL, defaults.getGreen(), defaults.getLineColor(), true, true));    markers.addRow(new MarkerDescriptor(Str.DN_MARKER1, get("EXIT_LONG"), Enums.MarkerType.TRIANGLE,        Enums.Size.VERY_SMALL, defaults.getRed(), defaults.getLineColor(), true, true));    markers.addRow(new MarkerDescriptor(Str.UP_MARKER2, get("EXIT_SHORT"), Enums.MarkerType.TRIANGLE,        Enums.Size.VERY_SMALL, defaults.getBlue(), defaults.getLineColor(), true, true));    markers.addRow(new MarkerDescriptor(Str.DN_MARKER2, get("ENTER_SHORT"), Enums.MarkerType.TRIANGLE,        Enums.Size.VERY_SMALL, defaults.getYellow(), defaults.getLineColor(), true, true));    markers.addRow(new MarkerDescriptor(Str.ACTIVE1, get("ACTIVE"), Enums.MarkerType.CIRCLE, Enums.Size.MEDIUM,        defaults.getGreen(), defaults.getLineColor(), true, true));    var desc=createRD();    desc.exportValue(new ValueDescriptor(Values.PZO, get("LBL_VZOSC"), new String[] { Str.INPUT1, Str.METHOD1, Str.PERIOD1 }));    desc.exportValue(new ValueDescriptor(Signal.ENTER_LONG, Enums.ValueType.BOOLEAN, get("ENTER_LONG"), null));    desc.exportValue(new ValueDescriptor(Signal.EXIT_LONG, Enums.ValueType.BOOLEAN, get("EXIT_LONG"), null));    desc.exportValue(new ValueDescriptor(Signal.ENTER_SHORT, Enums.ValueType.BOOLEAN, get("ENTER_SHORT"), null));    desc.exportValue(new ValueDescriptor(Signal.EXIT_SHORT, Enums.ValueType.BOOLEAN, get("EXIT_SHORT"), null));    desc.declareSignal(Signal.ENTER_LONG, get("ENTER_LONG"));    desc.declareSignal(Signal.EXIT_LONG, get("EXIT_LONG"));    desc.declareSignal(Signal.ENTER_SHORT, get("ENTER_SHORT"));    desc.declareSignal(Signal.EXIT_SHORT, get("EXIT_SHORT"));    // Price plot (moving average)    desc.getPricePlot().setLabelSettings(Str.INPUT1, Str.PERIOD2);    desc.getPricePlot().setLabelPrefix("MA");    desc.getPricePlot().declarePath(Values.MA, Str.PATH2);    desc.getPricePlot().declareIndicator(Values.MA, Str.IND2);    // default plot    desc.setLabelSettings(Str.INPUT1, Str.METHOD1, Str.PERIOD1);    desc.declarePath(Values.PZO, Str.PATH1);    desc.declareIndicator(Values.PZO, Str.IND1);    desc.setRangeKeys(Values.PZO);    // ADX Plot    Plot adxPlot=new Plot();    desc.addPlot(Str.PLOT1, adxPlot);    adxPlot.setLabelSettings(Str.INPUT1, Str.PERIOD1);    adxPlot.setLabelPrefix("ADX");    adxPlot.setTabName("ADX");    adxPlot.declarePath(Values.ADX, Str.PATH3);    adxPlot.declareBars(Values.ADX, Str.PATH3);    adxPlot.declareIndicator(Values.ADX, Str.IND3);    adxPlot.declareGuide(Str.TOP_GUIDE4);    adxPlot.declareGuide(Str.MID_GUIDE4);    adxPlot.declareGuide(Str.BOTT_GUIDE4);    adxPlot.setRangeKeys(Values.ADX);  }  @Override  public void onDeactivate(OrderContext ctx)  {    activationTime=0;    removeFigure(activeMarker);    // setState(Enums.StrategyState.INACTIVE);    super.onDeactivate(ctx);    var dctx=ctx.getDataContext();    var series=dctx.getDataSeries();    int lastIndex=series.size() - 1;    // call calculate to display hypothetical past signals    for(int i=0; i < lastIndex; i++) {      calculate(i, dctx);    }  }  @Override  public void onActivate(OrderContext ctx)  {    // clearFigures();    var series=ctx.getDataContext().getDataSeries();    int ind=Utility.iif(series.isLastBarComplete(), series.size() - 1, series.size() - 2);    activationTime=series.getStartTime(ind);    double value=series.getDouble(ind, Values.PZO, 0);    var c=new Coordinate(series.getStartTime(ind), value);    showActiveMarker(c);    super.onActivate(ctx);  }  @Override  public void onSignal(OrderContext ctx, Object signal)  {    var instr=ctx.getInstrument();    float qty=(getSettings().getTradeLots() * instr.getDefaultQuantityAsFloat());    acc.processSignal(ctx, (Signal) signal, qty, price);  }  @Override  public void onLoad(Defaults defaults)  {    int p1=getSettings().getInteger(Str.PERIOD1);    int p2=getSettings().getInteger(Str.PERIOD2);    setMinBars(p1 + p2);  }  @Override  protected void calculate(int index, DataContext ctx)  {    int period=getSettings().getInteger(Str.PERIOD1);    int maPeriod=getSettings().getInteger(Str.PERIOD2);    if (index < Math.max(period, maPeriod)) return;    Object key=getSettings().getInput(Str.INPUT1, Enums.BarInput.CLOSE);    var method=getSettings().getMAMethod(Str.METHOD1);    boolean reduceWS=getSettings().getBoolean(REDUCE_WS);    Color upC=getSettings().getColor(Str.UP_COLOR);    Color downC=getSettings().getColor(Str.DN_COLOR);    var series=ctx.getDataSeries();    price=series.getDouble(index, key, 0);    double prevPrice=series.getDouble(index - 1, key, 0);    // double r = Utility.sign(price, prevPrice) * price;    double r=Utility.iif(price > prevPrice, price, -price);    series.setDouble(index, Values.R, r);    Double ma=series.ma(method, index, maPeriod, key);    Double cp=series.ma(method, index, period, Values.R);    Double tc=series.ma(method, index, period, key);    if (ma == null || cp == null || tc == null) return;    Double pzo=null;    if (tc != 0) pzo=100.0 * cp / tc;    series.setDouble(index, Values.MA, ma);    series.setDouble(index, Values.PZO, pzo);    if (pzo == null) return;    double prevPzo=series.getDouble(index - 1, Values.PZO, 0);    // ADX    // Calculate the +DM, -DM and TR    Float pdm=series.getPositiveDM(index);    Float ndm=series.getNegativeDM(index);    Float tr=series.getTrueRange(index);    series.setFloat(index, Values.PDM, pdm);    series.setFloat(index, Values.NDM, ndm);    series.setFloat(index, Values.TR, tr);    if (index <= period) return; // not enough data to calculate the first set of averages    // Calculate the Average +DM, -DM and TR    Double pdma=series.smma(index, period, Values.PDM);    Double ndma=series.smma(index, period, Values.NDM);    Double tra=series.smma(index, period, Values.TR);    if (pdma == null || ndma == null || tra == null) return;    // Determine the +DI, -DI and DX    double pdi=pdma / tra * 100;    double ndi=ndma / tra * 100;    double dx=Math.abs((pdma - ndma)) / (pdma + ndma) * 100;    series.setDouble(index, Values.DX, dx);    series.setDouble(index, Values.PDI, pdi);    series.setDouble(index, Values.NDI, ndi);    // Calculate the Average DX    Double adx=series.smma(index, period, Values.DX);    if (adx == null) return;    series.setDouble(index, Values.ADX, adx);    // Check for signal events    double topG60=getSettings().getGuide(Str.TOP_GUIDE1).getValue();    double topG40=getSettings().getGuide(Str.TOP_GUIDE2).getValue();    double topG15=getSettings().getGuide(Str.TOP_GUIDE3).getValue();    double midG=getSettings().getGuide(Str.MID_GUIDE1).getValue(); // default = 0    double bottG60=getSettings().getGuide(Str.BOTT_GUIDE3).getValue();    double bottG40=getSettings().getGuide(Str.BOTT_GUIDE2).getValue();    double bottG5=getSettings().getGuide(Str.BOTT_GUIDE1).getValue();    double adxMidG=getSettings().getGuide(Str.MID_GUIDE4).getValue(); // default = 18    if (adx > adxMidG) series.setBarColor(index, Values.ADX, upC);    else series.setBarColor(index, Values.ADX, downC);    boolean enterLong=false, exitLong=false, enterShort=false, exitShort=false;    // uptrend    if (price > ma && adx > adxMidG) {      if (reduceWS) enterLong=(prevPzo < bottG40 && pzo > bottG40) || (prevPzo < topG15 && pzo > topG15);      if (!reduceWS) enterLong=(prevPzo < bottG40 && pzo > bottG40) || (prevPzo < midG && pzo > midG);      exitLong=((prevPzo > topG60 && pzo < prevPzo) || (prevPzo > topG40 && pzo < topG40)          || (price < ma && pzo < midG));    }    // down trend    if (price < ma && adx > adxMidG) {      if (reduceWS) enterShort=(prevPzo > topG40 && pzo < topG40) || (prevPzo > bottG5 && pzo < bottG5);      if (!reduceWS) enterShort=(prevPzo > topG40 && pzo < topG40) || (prevPzo > midG && pzo < midG);      exitShort=(pzo < bottG60 && pzo > prevPzo) || (prevPzo < bottG40 && pzo > bottG40)          || (price > ma && prevPzo < midG && pzo > midG);    }    // non trending    if (adx < adxMidG) {      enterLong=(prevPzo < bottG40 && pzo > bottG40) || (prevPzo < topG15 && pzo > topG15);      if ((prevPzo < topG40 && pzo > topG40)) {        if (reduceWS) exitLong=(prevPzo < topG15 && pzo > topG15);        if (!reduceWS) exitLong=(prevPzo < midG && pzo > midG);      }      if (pzo < topG40) exitLong=(prevPzo > bottG5 && pzo < bottG5);      enterShort=(prevPzo > topG40 && pzo < topG40) || (prevPzo > bottG5 && pzo < bottG5);      exitShort=(prevPzo > bottG40 && pzo < bottG40) || pzo > topG15;    }    if (enterLong) {      var c=new Coordinate(series.getStartTime(index), pzo);      var markerInfo=getSettings().getMarker(Str.UP_MARKER1);      var marker=new Marker(c, Enums.Position.BOTTOM, markerInfo);      marker.setTextValue(get("ENTER_LONG"));      marker.setTextPosition(Enums.Position.BOTTOM);      if (markerInfo.isEnabled()) addFigure(marker);      ctx.signal(index, Signal.ENTER_LONG, get("ENTER_LONG_PRICE_PZO", Util.round(price, 3), Util.round(pzo, 3)), price);    }    if (exitLong) {      var c=new Coordinate(series.getStartTime(index), pzo);      var markerInfo=getSettings().getMarker(Str.DN_MARKER1);      var marker=new Marker(c, Enums.Position.TOP, markerInfo);      marker.setTextValue(get("EXIT_LONG"));      marker.setTextPosition(Enums.Position.TOP);      if (markerInfo.isEnabled()) addFigure(marker);      ctx.signal(index, Signal.EXIT_LONG, get("EXIT_LONG_PRICE_PZO", Util.round(price, 3), Util.round(pzo, 3)), price);    }    if (enterShort) {      var c=new Coordinate(series.getStartTime(index), pzo);      var markerInfo=getSettings().getMarker(Str.DN_MARKER2);      var marker=new Marker(c, Enums.Position.TOP, markerInfo);      marker.setTextValue(get("ENTER_SHORT"));      marker.setTextPosition(Enums.Position.TOP);      if (markerInfo.isEnabled()) addFigure(marker);      ctx.signal(index, Signal.ENTER_SHORT, get("ENTER_SHORT_PRICE_PZO", Util.round(price, 3), Util.round(pzo, 3)), price);    }    if (exitShort) {      var c=new Coordinate(series.getStartTime(index), pzo);      var markerInfo=getSettings().getMarker(Str.UP_MARKER2);      var marker=new Marker(c, Enums.Position.BOTTOM, markerInfo);      marker.setTextValue(get("EXIT_SHORT"));      marker.setTextPosition(Enums.Position.BOTTOM);      if (markerInfo.isEnabled()) addFigure(marker);      ctx.signal(index, Signal.EXIT_SHORT, get("EXIT_SHORT_PRICE_PZO", Util.round(price, 3), Util.round(pzo, 3)), price);    }    series.setComplete(index);  }  public void showActiveMarker(Coordinate c)  {    var markerInfo=getSettings().getMarker(Str.ACTIVE1);    activeMarker=new Marker(c, Enums.Position.BOTTOM, markerInfo);    activeMarker.setTextValue(get("ACTIVE"));    activeMarker.setTextPosition(Enums.Position.BOTTOM);    addFigure(activeMarker);  }}